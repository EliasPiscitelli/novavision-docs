

  

Created 6 todos

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/implementations/SystemE2E.md)

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs)

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/runbooks)

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/architecture)

Created 6 todos

Ahora necesito leer los docs reales del producto para contrastar con el documento E2E.    

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/runbooks/onboarding_complete_guide.md#1-1), lines 1 to 150

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/architecture/system_flows_and_persistence.md#1-1), lines 1 to 150

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/architecture/FLOW_DIAGRAM.md#1-1), lines 1 to 150

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/implementations)

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/runbooks/onboarding_complete_guide.md#150-150), lines 150 to 610

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/architecture/system_flows_and_persistence.md#150-150), lines 150 to 400

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/NovaVisionRepo/apps/web/e2e)

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/architecture/OVERVIEW.md#1-1), lines 1 to 100

Investigar tests E2E y docs reales

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/NovaVisionRepo/apps/web/e2e/auth-login-unconfirmed.spec.ts)

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/NovaVisionRepo/apps/web/e2e/cart-admin-rules.spec.ts#1-1), lines 1 to 200

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/NovaVisionRepo/apps/web/playwright.config.ts)

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/NovaVisionRepo/apps/web/package.json)

Searched for files matching `**/playwright.config*`, 1 match

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/GO_LIVE_CHECKLIST.md#1-1), lines 1 to 300

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/NovaVisionRepo/apps/web/e2e/cart-admin-rules.spec.ts#200-200), lines 200 to 387

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/GO_LIVE_CHECKLIST.md#300-300), lines 300 to 435

Searched for regex `mercadopago|webhook` (`**/apps/api/src/**/*.ts`), no results

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/NovaVisionRepo/apps/api/src/onboarding)

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/NovaVisionRepo/apps/api/src/tenant-payments)

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/architecture/subscription-guardrails.md)

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/architecture/store_render_flow.md)

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/architecture/config-source-of-truth.md)

Searched for regex `mercadopago|webhook` (`**/apps/api/src/**`), no results

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/NovaVisionRepo/apps/api/src/onboarding/dto)

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/NovaVisionRepo/apps/api/src/onboarding/validators)

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/NovaVisionRepo/apps/api/src/tenant-payments/dto)

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/NovaVisionRepo/apps/api/src/tenant-payments/helpers)

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/NovaVisionRepo/apps/api/src/tenant-payments/__tests__)

Ran terminal command:  find /Users/eliaspiscitelli/Documents/NovaVision/NovaVisionRepo/apps/api/src -type f -name "*.ts" | xargs grep -li "mercadopago\|webhook\|MercadoPago\|Webhook" 2>/dev/null | sort

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/NovaVisionRepo/apps/api/src/controllers)

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/NovaVisionRepo/apps/api/src/webhooks)

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/NovaVisionRepo/apps/api/src/subscriptions)

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/NovaVisionRepo/apps/api/src/payments)

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/NovaVisionRepo/apps/api/src/services)

Starting: *Analizar flujos reales (onboarding, tienda, checkout)* (4/6)

Leer docs restantes para auditoría

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/architecture/subscription-hardening-plan.md#1-1), lines 1 to 500

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/architecture/cross-db-consistency.md)

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/architecture/database-schema-reference.md#1-1), lines 1 to 300

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/audit)

Searched for regex `sandbox|test_mode|TEST.*[Mm]ercado|SANDBOX` (`**/apps/**`), 1 result

Searched for text `external_reference` (`**/apps/api/src/**`), no results

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/architecture/system_flows_and_persistence.md#400-400), lines 400 to 781

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/architecture/subscription-hardening-plan.md#501-501), lines 501 to 677

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/architecture/database-schema-reference.md#301-301), lines 301 to 304

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/audit/NOVAVISION_SYSTEM_AUDIT.md#1-1), lines 1 to 500

Searched for text `external_reference` (`**/apps/api/src/**`), no results

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/audit/billing-subscription-flow.md#1-1), lines 1 to 300

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/audit/customer-store-lifecycle-audit.md#1-1), lines 1 to 300

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/audit/NOVAVISION_SYSTEM_AUDIT.md#501-501), lines 501 to 917

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/audit/billing-subscription-flow.md#301-301), lines 301 to 497

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/audit/customer-store-lifecycle-audit.md#301-301), lines 301 to 600

Searched for text `external_reference` (`**/apps/api/src/**`), no results

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/audit/customer-store-lifecycle-audit.md#601-601), lines 601 to 900

Searched for text `external_reference`, 20 results

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/audit/client-dashboard-audit.md)

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/audit/customer-store-lifecycle-audit.md#901-901), lines 901 to 1153

Read [](file:///Users/eliaspiscitelli/Documents/NovaVision/novavision-docs/audit/client-dashboard-plan.md)

Searched for regex `external_reference|NV_SUB|NV_ORD|NVBILL` (`**/apps/api/src/**`), no results

Searched for regex `external_reference|NV_SUB|NV_ORD|NVBILL` (`**/apps/api/src/**`), no results

Searched for regex `sandbox|test_mode|MP_SANDBOX|SANDBOX_MODE` (`**/apps/api/src/**`), no results

Ran terminal command:  grep -rn "external_reference\|NV_SUB\|NV_ORD\|NVBILL" /Users/eliaspiscitelli/Documents/NovaVision/NovaVisionRepo/apps/api/src/ 2>/dev/null | head -60

Ran terminal command:  grep -rn "sandbox\|SANDBOX\|test_mode\|live_mode\|MP_SANDBOX" /Users/eliaspiscitelli/Documents/NovaVision/NovaVisionRepo/apps/api/src/ --include="*.ts" 2>/dev/null | head -40

Starting: *Construir auditoría completa* (5/6)

Tengo toda la información necesaria. Ahora construyo la auditoría completa. 

Starting: *Entregar informe final* (6/6)

---

# Auditoría E2E — `novavision-e2e` (SystemE2E.md)

**Rol:** Principal QA Architect + Playwright/TypeScript Lead
**Fecha:** 2026-02-07
**Alcance:** Documento SystemE2E.md vs. sistema real (docs, código, configuración existente)

---

## 1) INVENTARIO

### 1.1 Lo que existe HOY (realidad del repo)

El repo `novavision-e2e` como tal **NO EXISTE**. SystemE2E.md es un **plan/guía**, no un repo implementado.

Lo que sí existe es una instalación Playwright **dentro de** web:

| Artefacto | Ubicación | Estado |
|---|---|---|
| Playwright config | apps/web/playwright.config.ts | Chromium only, build+preview, 120s timeout |
| Test 1 | apps/web/e2e/auth-login-unconfirmed.spec.ts | 1 test, 100% mockeado |
| Test 2 | apps/web/e2e/cart-admin-rules.spec.ts | 3 tests, 100% mockeados |
| Scripts | `test:e2e`, `test:e2e:ci` en package.json | Funcionales |
| Playwright version | `^1.47.0` | OK pero no última |
| Navegadores | Solo Chromium | ⚠️ Sin Firefox/Safari |

### 1.2 Lo que propone SystemE2E.md

Una estructura genérica:
```
novavision-e2e/
├── tests/
├── pages/
├── fixtures/
├── utils/
├── data/
├── playwright.config.ts
├── tsconfig.json
└── package.json
```

### 1.3 Diagnóstico

| Aspecto | Veredicto |
|---|---|
| Estructura propuesta | ❌ Genérica, no refleja el dominio NV (no hay carpetas por actor: onboarding/shopper/admin) |
| Page Objects concretos | ❌ Los nombra (`OnboardingPage`, `StorePage`, `CheckoutPage`) pero no los detalló contra los flujos reales |
| Fixtures | ❌ No hay plan de `storageState`, seed de datos, ni limpieza post-test |
| Runner/CLI | ❌ `spawnSync('npx', ['playwright', 'test'])` es un wrapper sin valor; no hay filtro por actor/tenant/device |
| Reporter | ⚠️ Solo HTML reporter. No hay JSON normalizado para consumo programático |
| Dependencias concretas | ❌ No menciona versiones de Node, Playwright, ni TypeScript |
| Multi-tenant | ❌ No aparece en la estructura ni en los casos |
| Mercado Pago sandbox | ❌ Cero mención a credenciales test, firewall, `external_reference` |
| Datos de prueba | ❌ Carpeta `data/` vacía conceptualmente. No hay plan de seed/teardown |

---

## 2) TRAZABILIDAD — Matriz Doc/Flujo → Tests → Cobertura

Documentos reales consultados:
- onboarding_complete_guide.md (610 líneas)
- system_flows_and_persistence.md (781 líneas)
- FLOW_DIAGRAM.md (359 líneas)
- subscription-guardrails.md (~300 líneas)
- store_render_flow.md
- config-source-of-truth.md
- cross-db-consistency.md
- NOVAVISION_SYSTEM_AUDIT.md (917 líneas)
- customer-store-lifecycle-audit.md (1153 líneas)
- database-schema-reference.md

### Matriz de cobertura

| # | Flujo (Doc fuente) | Tests existentes (web/e2e) | Tests en SystemE2E.md | Cobertura |
|---|---|---|---|---|
| **A** | **Onboarding completo** (10 pasos: draft→slug→logo→catalog→design→checkout MP→payment→identity→provisioning→live) — onboarding_complete_guide.md | **0 tests** | Menciona "OnboardingPage" sin detallar los 10 pasos | ❌ **FALTA** |
| **B** | **Design Studio** (template selection + palette + sections + plan gating) — system_flows_and_persistence.md | **0 tests** | No mencionado | ❌ **FALTA** |
| **C** | **Checkout Mercado Pago tienda** (buscar→carrito→preference→MP→webhook→confirm) — FLOW_DIAGRAM.md | 3 tests mockeados (cart-admin-rules) validan DTO/headers | "CheckoutPage" genérico | ⚠️ **PARCIAL** (solo request shape, no flow real) |
| **D** | **Suscripciones plataforma** (create preapproval→webhook→lifecycle→reconcile) — `subscription-guardrails.md` | **0 tests** | No mencionado | ❌ **FALTA** |
| **E** | **Multi-tenant** (resolver por slug/domain, aislamiento client_id, RLS) — `config-source-of-truth.md` | **0 tests** | No mencionado | ❌ **FALTA** |
| **F** | **Store rendering** (useFetchHomeData→HomeRouter→ThemeProvider→template) — `store_render_flow.md` | **0 tests** | No mencionado | ❌ **FALTA** |
| **G** | **Auth** (login, registro, email unconfirmed, roles) | 1 test (login unconfirmed, mockeado) | "registerUser" genérico | ⚠️ **PARCIAL** |
| **H** | **Seguridad** (IDOR, tenant isolation, maintenance_mode, sandbox firewall) — `NOVAVISION_SYSTEM_AUDIT.md`, `customer-store-lifecycle-audit.md` | **0 tests** | No mencionado | ❌ **FALTA** |
| **I** | **Cross-DB consistency** (Admin→Backend sync, provisioning) — `cross-db-consistency.md` | **0 tests** | No mencionado | ❌ **FALTA** |
| **J** | **Identity collection** (DNI post-payment, blocking modal) — system_flows_and_persistence.md | **0 tests** | No mencionado | ❌ **FALTA** |

**Cobertura real: 2/10 flujos con tests parciales. 0 flujos con cobertura completa.**

---

## 3) CALIDAD PLAYWRIGHT — Criterios duros

Evaluación contra los 4 tests existentes en `apps/web/e2e/`:

| Criterio | Veredicto | Detalle |
|---|---|---|
| **Selectores** | ⚠️ | Usan `page.locator('[data-testid=...]')` y `page.getByText()` — aceptable, pero `auth-login` inyecta un harness HTML completo como fallback, lo cual es un code smell; indica que la app no es testeable limpiamente |
| **Anti-flakiness** | ⚠️ | No hay `waitForLoadState` consistente; timeout de 120s es excesivo (compensación de fragilidad). No hay retries locales (solo en CI: 1 retry) |
| **Sleeps** | ✅ | No se detectaron `page.waitForTimeout()` hardcodeados |
| **Patrón AAA** | ⚠️ | Arrange/Act mezclados. Los tests mockean todo (sin API real), lo que los convierte en tests de integración UI, no E2E |
| **Page Objects** | ❌ | **No existen.** Los 2 archivos son scripts lineales con selectores inline |
| **Fixtures** | ❌ | No hay `storageState`, no hay login fixture, no hay seed de datos |
| **Paralelismo** | ⚠️ | `fullyParallel: true` en config pero con 4 tests no impacta. No hay análisis de qué debe ser serial (pagos, onboarding) |
| **Evidencias** | ❌ | No hay captura de trace/video/screenshots configurada en playwright.config.ts. Solo reporter HTML |
| **Logs de red** | ✅ | `cart-admin-rules` intercepta y valida requests (headers, body). `auth-login` captura console errors |
| **Naming** | ⚠️ | `TC-013` es críptico. `Scenario A/B/C` es genérico. No hay tags `@onboarding`, `@payments` |

### Evaluación de SystemE2E.md como plan

| Criterio del plan | Veredicto | Detalle |
|---|---|---|
| Selectores | ⚠️ | Menciona `getByRole`/`getByLabel` pero no define estrategia de `data-testid` para la app |
| Patrón AAA | ✅ | Lo describe correctamente |
| Page Objects | ⚠️ | Nombra 3 clases genéricas sin definir los selectores/métodos reales según flujos documentados |
| Fixtures | ❌ | Menciona la carpeta pero no define qué fixtures crear |
| Paralelismo | ❌ | No analizado |
| Evidencias | ❌ | Solo configuró reporter HTML; no hay trace/video/screenshots |
| Manejo de errores | ❌ | No contemplado |
| Multi-tenant | ❌ | Ignorado completamente |
| Sandbox/credenciales | ❌ | No mencionado |

---

## 4) RIESGOS — Sandbox / Credenciales Test / Pagos Reales

### 4.1 Estado actual del firewall sandbox

**Hallazgos en el backend (código real):**

| Protección | Ubicación | Tipo |
|---|---|---|
| Bloqueo test users en prod | `subscriptions.service.ts` L462 | IF email contiene `test_user_*` → throw en prod |
| Skip sandbox subs en reconcile | `subscriptions.service.ts` L1818 | IF `isProduction && live_mode === false` → skip |
| `MP_SANDBOX_MODE` config | `platform-mercadopago.service.ts` | Swapea email en sandbox |
| `MP_FORCE_SANDBOX` | `mercadopago.service.ts` L707 | Rechaza si falta `init_point` en prod |
| `mp_live_mode` en nv_accounts | `mp-oauth.service.ts` | Persiste modo por tenant |

**Veredicto: ⚠️ PARCIAL.** Hay protecciones **distribuidas en 5+ archivos sin un middleware centralizado**. No existe un `SandboxGuard` global ni un pre-flight check al iniciar el test runner.

### 4.2 Lo que FALTA (FAIL)

1. **No hay mecanismo de validación pre-run en el framework E2E** que confirme:
   - `MP_SANDBOX_MODE=true` activo
   - Que las credenciales MP del tenant bajo test son de test (no live)
   - Que `mp_live_mode=false` en `nv_accounts` del tenant testeado

2. **No hay etiquetado de órdenes/pagos de test con `runId`**: El `external_reference` usa formato `NV_ORD:{clientId}:{orderId}` pero no incluye ningún tag E2E ni `runId` que permita identificar y limpiar datos generados por el runner.

3. **No hay limpieza post-test**: Ni en los tests existentes ni en SystemE2E.md hay plan de teardown que elimine orders/cart_items/payments creados durante la ejecución.

### 4.3 Propuesta concreta

```typescript
// fixtures/sandbox-guard.ts
import { test as base, expect } from '@playwright/test';

export const test = base.extend<{ ensureSandbox: void }>({
  ensureSandbox: [async ({ request }, use) => {
    // Pre-flight: validar que la API está en modo sandbox
    const health = await request.get(`${API_URL}/health`);
    const data = await health.json();
    
    // BLOQUEO DURO: si la API reporta producción, abortar
    expect(data.mp_sandbox_mode, 'API debe estar en modo sandbox').toBe(true);
    
    // Validar que el tenant de test tiene mp_live_mode=false
    const tenant = await request.get(`${API_URL}/store/config/${TEST_SLUG}`);
    const config = await tenant.json();
    expect(config.mp_live_mode, 'Tenant debe estar en modo test').toBeFalsy();
    
    await use();
  }, { auto: true }],
});
```

```typescript
// fixtures/run-context.ts  
export function generateRunId(): string {
  return `E2E_${Date.now()}_${crypto.randomUUID().slice(0, 8)}`;
}

// Cada preference creada debe incluir en metadata:
// external_reference: `NV_ORD:${clientId}:${orderId}:E2E:${runId}`
```

```typescript
// fixtures/teardown.ts
export async function cleanupTestData(supabase: SupabaseClient, runId: string) {
  // Borrar payments, orders, cart_items con external_reference LIKE '%E2E%{runId}%'
  await supabase.from('orders').delete().like('external_reference', `%E2E:${runId}%`);
  await supabase.from('cart_items').delete().eq('client_id', TEST_CLIENT_ID);
}
```

---

## 5) MEJORAS ACCIONABLES

### 5.1 Estructura target del repo

```
novavision-e2e/
├── playwright.config.ts          # Multi-project: chromium, firefox, mobile
├── tsconfig.json
├── package.json
├── .env.test                     # Vars del runner (API_URL, TEST_SLUG, MP creds)
├── .env.test.example
│
├── src/
│   ├── fixtures/
│   │   ├── sandbox-guard.ts      # Pre-flight: modo test MP obligatorio
│   │   ├── auth.fixture.ts       # Login → storageState por rol (admin, user, anon)
│   │   ├── tenant.fixture.ts     # Resuelve config del tenant bajo test
│   │   ├── run-context.ts        # runId, timestamps, metadata
│   │   └── teardown.ts           # Limpieza post-suite
│   │
│   ├── pages/                    # Page Objects por dominio
│   │   ├── onboarding/
│   │   │   ├── SlugPage.ts
│   │   │   ├── LogoUploadPage.ts
│   │   │   ├── CatalogPage.ts
│   │   │   ├── DesignStudioPage.ts
│   │   │   ├── CheckoutPage.ts
│   │   │   └── IdentityModal.ts
│   │   ├── storefront/
│   │   │   ├── HomePage.ts
│   │   │   ├── PLPPage.ts
│   │   │   ├── PDPPage.ts
│   │   │   ├── CartDrawer.ts
│   │   │   └── PaymentResultPage.ts
│   │   ├── admin/
│   │   │   ├── DashboardPage.ts
│   │   │   ├── ProductsPage.ts
│   │   │   └── SettingsPage.ts
│   │   └── common/
│   │       ├── HeaderComponent.ts
│   │       └── ToastComponent.ts
│   │
│   ├── helpers/
│   │   ├── api-client.ts         # Wrapper fetch con x-client-id, auth
│   │   ├── supabase-seed.ts      # Seed/cleanup directo a DB
│   │   ├── mp-test-cards.ts      # Tarjetas test de MP por escenario
│   │   └── assertions.ts         # Custom matchers (expect extensiones)
│   │
│   └── data/
│       ├── tenants.json          # Slugs, client_ids para test
│       ├── products.json         # Productos seed
│       ├── test-cards.json       # Tarjetas MP sandbox
│       └── users.json            # Credenciales test por rol
│
├── tests/
│   ├── onboarding/
│   │   ├── 01-start-draft.spec.ts
│   │   ├── 02-logo-upload.spec.ts
│   │   ├── 03-catalog-import.spec.ts
│   │   ├── 04-design-studio.spec.ts
│   │   ├── 05-checkout-mp.spec.ts
│   │   ├── 06-identity-collection.spec.ts
│   │   └── 07-provisioning-live.spec.ts
│   ├── storefront/
│   │   ├── home-render.spec.ts
│   │   ├── plp-filters.spec.ts
│   │   ├── pdp-detail.spec.ts
│   │   ├── cart-operations.spec.ts
│   │   ├── checkout-debit.spec.ts
│   │   ├── checkout-credit.spec.ts
│   │   └── payment-result.spec.ts
│   ├── multitenant/
│   │   ├── tenant-isolation.spec.ts
│   │   ├── two-stores-parallel.spec.ts
│   │   └── slug-resolution.spec.ts
│   ├── security/
│   │   ├── idor-basic.spec.ts
│   │   ├── role-enforcement.spec.ts
│   │   ├── maintenance-mode.spec.ts
│   │   └── sandbox-firewall.spec.ts
│   └── smoke/
│       └── health-check.spec.ts
│
├── runs/                          # Artefactos por ejecución (gitignored)
│   └── <runId>/
│       ├── report.json
│       ├── report.md
│       ├── traces/
│       ├── screenshots/
│       └── videos/
│
├── scripts/
│   ├── run.ts                    # CLI orquestador
│   └── generate-report.ts       # JSON → MD para Fixer Agent
│
└── docs/
    └── FLUJOS.md                  # Mapa flujos → tests (trazabilidad)
```

### 5.2 Convenciones

**Naming:**
- Tests: `{dominio}/{NN}-{accion-kebab}.spec.ts` → `onboarding/01-start-draft.spec.ts`
- Page Objects: `PascalCase` por pantalla real → `DesignStudioPage.ts`
- Fixtures: `kebab-case` → `sandbox-guard.ts`

**Tags (via `test.describe`):**
```typescript
test.describe('@onboarding @serial', () => { ... });
test.describe('@storefront @checkout @payments', () => { ... });
test.describe('@multitenant @parallel', () => { ... });
test.describe('@security @idor', () => { ... });
```

**Ejecución serial vs parallel:**

| Suite | Modo | Razón |
|---|---|---|
| `onboarding/` | Serial | Flujo secuencial con estado compartido |
| `storefront/` | Parallel | Tests independientes, distintos products |
| `multitenant/` | Serial | Dos browsers coordinados |
| `security/` | Parallel | Tests independientes |
| `smoke/` | Parallel | Fast checks |

### 5.3 Runner/Orquestador (CLI)

```typescript
// scripts/run.ts
import { execSync } from 'child_process';

const ACTORS = {
  onboarding: 'tests/onboarding/',
  storefront: 'tests/storefront/',
  multitenant: 'tests/multitenant/',
  security:    'tests/security/',
  smoke:       'tests/smoke/',
};

const args = process.argv.slice(2);
const actor   = args.find(a => !a.startsWith('--'));
const tenant  = args.find(a => a.startsWith('--tenant='))?.split('=')[1];
const device  = args.find(a => a.startsWith('--device='))?.split('=')[1] || 'desktop';
const mode    = args.includes('--smoke') ? 'smoke' : 'full';
const runId   = `E2E_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;

const testDir = actor ? ACTORS[actor] || actor : '';
const grep    = mode === 'smoke' ? '--grep @smoke' : '';
const project = device === 'mobile' ? '--project=mobile-chrome' : '--project=chromium';
const envVars = tenant ? `TEST_TENANT_SLUG=${tenant}` : '';

const cmd = [
  envVars,
  'npx playwright test',
  testDir,
  project,
  grep,
  `--output=runs/${runId}`,
  '--reporter=json,html',
].filter(Boolean).join(' ');

console.log(`[${runId}] Ejecutando: ${cmd}`);
execSync(cmd, { stdio: 'inherit', env: { ...process.env, E2E_RUN_ID: runId } });
```

**Uso:**
```bash
npx ts-node scripts/run.ts storefront --tenant=urbanprint --device=mobile
npx ts-node scripts/run.ts onboarding --smoke
npx ts-node scripts/run.ts security
npx ts-node scripts/run.ts              # full suite
```

### 5.4 Report normalizado

```jsonc
// runs/<runId>/report.json
{
  "runId": "E2E_1707307200_x3k9m2",
  "timestamp": "2026-02-07T15:00:00Z",
  "tenant": "urbanprint",
  "device": "desktop",
  "mode": "full",
  "duration_ms": 142000,
  "summary": {
    "total": 28,
    "passed": 25,
    "failed": 2,
    "skipped": 1,
    "flaky": 0
  },
  "failures": [
    {
      "id": "storefront/checkout-credit.spec.ts::credit-6-installments",
      "title": "Checkout con crédito 6 cuotas debería mostrar desglose",
      "suite": "storefront",
      "tags": ["@payments", "@checkout"],
      "error": "expect(received).toBeVisible() - Locator: getByTestId('breakdown-total')",
      "screenshot": "runs/E2E_.../screenshots/checkout-credit-failure.png",
      "trace": "runs/E2E_.../traces/checkout-credit.zip",
      "suggestedFix": "Verificar que PaymentBreakdown component renderiza cuando settlement_days > 0"
    }
  ],
  "coverage": {
    "onboarding": { "total": 7, "passed": 7 },
    "storefront": { "total": 12, "passed": 10, "failed": 2 },
    "multitenant": { "total": 3, "passed": 3 },
    "security": { "total": 5, "passed": 5 },
    "smoke": { "total": 1, "passed": 1, "skipped": 0 }
  }
}
```

---

## 6) SALIDA FORMAL

### A) Hallazgos Críticos

| Sev | Hallazgo | Impacto | Evidencia |
|---|---|---|---|
| **S1** | **No existe el repo `novavision-e2e`.** SystemE2E.md es solo una guía teórica de 10 pasos. Los únicos 4 tests E2E están en `apps/web/e2e/` y son 100% mockeados | Cero cobertura E2E real contra APIs/DB. Cualquier regresión en flujos críticos (onboarding, pagos, multi-tenant) pasa invisible | SystemE2E.md: documento sin implementación; apps/web/e2e/: 2 archivos, 4 tests mockeados |
| **S1** | **No hay firewall centralizado ni pre-flight check para modo sandbox.** Las protecciones están distribuidas en 5+ archivos backend sin wrapper de test runner | Un error de configuración (env var omitida) puede resultar en pagos reales durante test runs | `subscriptions.service.ts` L462, `mercadopago.service.ts` L707, `platform-mercadopago.service.ts` L211 — cada uno implementa su propia validación |
| **S1** | **No hay mecanismo de limpieza (teardown) de datos de test.** No hay runId en `external_reference`, no hay cleanup post-ejecución | Contamina la DB de staging/test con órdenes fantasma; complica debugging y puede disparar reconcile/billing sobre datos falsos | Ausente en ambos: SystemE2E.md y tests existentes |
| **S2** | **SystemE2E.md no referencia NINGÚN documento real del producto.** Propone tests genéricos ("OnboardingPage", "CheckoutPage") sin anclar a los 10 pasos documentados en onboarding_complete_guide.md ni al flow de FLOW_DIAGRAM.md | Los tests resultantes serían superficiales y no cubrirían los edge cases documentados (plan gating, identity modal, provisioning worker, cross-DB sync) | SystemE2E.md paso 4: "Lee la documentación interna" — pero no cita ningún doc por nombre |
| **S2** | **0 cobertura multi-tenant.** Ni un solo test valida aislamiento entre tenants | El riesgo R2 documentado (`categories.name` UNIQUE global, no por tenant) y BUG-002 (`'live'` no está en constraint de status) son bugs que un test E2E atraparía | customer-store-lifecycle-audit.md R2, R7 |
| **S2** | **No hay Page Objects.** Los 4 tests existentes tienen selectores inline hardcodeados. `auth-login` inyecta un harness HTML completo como fallback | Flaky tests, mantenimiento imposible a escala, no reusables entre suites | auth-login-unconfirmed.spec.ts: inyecta `document.body.innerHTML = ...` |
| **S3** | **Solo Chromium.** Sin Firefox ni Safari en la config. Sin mobile viewports | Bugs de CSS/layout en Safari/Firefox pasan invisibles (NovaVision es un producto público) | playwright.config.ts: `projects: [{ name: 'chromium' }]` |
| **S3** | **Sin traces/videos/screenshots** configurados | Post-mortem de failures imposible sin evidencia visual | playwright.config.ts: no tiene `use: { trace, video, screenshot }` |
| **S3** | **Runner trivial propuesto** (`spawnSync('npx', ['playwright', 'test'])`) no agrega valor sobre `npm test` | No hay filtro por actor, tenant, device, ni modo smoke/full | SystemE2E.md paso 8 |

### B) Brechas de Cobertura por Flujo

| Flujo | Qué falta | Por qué importa |
|---|---|---|
| **Onboarding (A)** | 0/10 pasos cubiertos. Falta: start-draft, slug reservation, logo upload, AI catalog import, Design Studio (template+palette+sections con plan gating), checkout MP, identity modal, provisioning worker, store goes live | Es el **flujo más crítico**: si falla, no hay clientes nuevos. 10 pasos secuenciales con dependencias cross-DB (Admin→Backend) |
| **Design Studio (B)** | 0 tests. Falta: addSection con plan limit, replaceSection con prop migration, UpsellModal, palette filtering por plan | Regresiones aquí rompen la propuesta de valor visual del producto |
| **Checkout tienda (C)** | Parcial (solo DTO shape mockeado). Falta: flow real con API (preference creation → redirect MP sandbox → webhook → order confirmed), desglose de pagos, partial payments, idempotency | Pagos rotos = pérdida directa de revenue para los clientes |
| **Suscripciones (D)** | 0 tests. Falta: create preapproval, webhook lifecycle, grace period, reconcile, upgrade path | Facturación de la plataforma. Fallas aquí impactan la contabilidad de NovaVision |
| **Multi-tenant (E)** | 0 tests. Falta: resolver slug, `x-client-id` header propagation, dos tiendas en paralelo sin leakage, `maintenance_mode` por tenant | Bug de aislamiento = datos de un cliente visibles para otro (data breach) |
| **Store rendering (F)** | 0 tests. Falta: template routing (5 templates), theme application, CSS variables, header fuera de ThemeProvider (bug conocido) | Visual roto = el cliente ve su tienda fea y cancela |
| **Seguridad (H)** | 0 tests. Falta: IDOR básico (acceder order de otro user), role enforcement (user no puede ir a /admin), RLS validation, sandbox firewall E2E | Sin estos tests, una release puede abrir brechas de seguridad silenciosamente |
| **Identity (J)** | 0 tests. Falta: blocking modal post-payment, DNI validation regex, `identity_verified` flow | Si el modal no aparece, NovaVision queda sin DNI del cliente (compliance) |

### C) Plan de Refactor — 3 Fases

#### Fase 1: Foundation (Semanas 1-2)

**Objetivo:** Repo operacional con sandbox guard, fixtures base, y smoke tests contra API real.

| Tarea | DoD |
|---|---|
| Crear repo `novavision-e2e` con estructura target | Repo en GitHub, CI corre `npm test` exitosamente |
| Implementar `sandbox-guard.ts` | Pre-flight check bloquea ejecución si `MP_SANDBOX_MODE ≠ true` o tenant no está en modo test |
| Implementar `auth.fixture.ts` con `storageState` | Login admin y user generan `storageState` reutilizable; tests no repiten login |
| Implementar `tenant.fixture.ts` | Resuelve `client_id`, `slug`, `preview_token` del tenant bajo test |
| Implementar `run-context.ts` | Cada ejecución genera `runId` propagado a `external_reference` |
| Implementar `teardown.ts` | Post-suite limpia orders/cart_items por `runId` |
| Escribir `smoke/health-check.spec.ts` | Valida API `/health` + store config + sandbox mode en <10s |
| Configurar Playwright: Chromium + Firefox, traces on-failure, video on-failure, screenshots on-failure | Config valida con `npx playwright test --list` |
| Escribir `storefront/home-render.spec.ts` | Visita tienda test por slug, valida template correcto, header visible, no console errors |

**DoD Fase 1:** 3-5 tests que corren contra API real en sandbox, con evidencias y cleanup automático.

#### Fase 2: Critical Paths (Semanas 3-5)

**Objetivo:** Cubrir los flujos de mayor impacto: checkout completo, multi-tenant, seguridad básica.

| Tarea | DoD |
|---|---|
| Page Objects: `HomePage`, `PLPPage`, `PDPPage`, `CartDrawer`, `PaymentResultPage` | Selectores por `data-testid` (requiere agregar testids en apps/web) |
| Escribir `storefront/cart-operations.spec.ts` | Agregar/quitar/actualizar items sin mocks |
| Escribir `storefront/checkout-debit.spec.ts` | Flow completo: carrito → preference → redirect MP sandbox → simular callback → validar order confirmed |
| Escribir `storefront/checkout-credit.spec.ts` | Igual pero con cuotas, validar breakdown |
| Escribir `multitenant/tenant-isolation.spec.ts` | Dos contextos de browser, dos slugs distintos, validar que products no se cruzan |
| Escribir `multitenant/slug-resolution.spec.ts` | `?tenant=slug` resuelve correctamente; slug inexistente → error |
| Escribir `security/idor-basic.spec.ts` | User A no puede acceder a order de User B (via API directa) |
| Escribir `security/role-enforcement.spec.ts` | User sin admin no puede acceder a `/admin/*` |
| Escribir `security/maintenance-mode.spec.ts` | Con maintenance_mode=true → 503 |
| Implementar runner CLI (`scripts/run.ts`) | Filtra por actor, tenant, device, smoke/full |

**DoD Fase 2:** 15-20 tests cubriendo checkout, multi-tenant y seguridad contra API real.

#### Fase 3: Full Coverage + CI (Semanas 6-8)

**Objetivo:** Onboarding E2E, suscripciones, report para Fixer Agent, CI integrado.

| Tarea | DoD |
|---|---|
| Page Objects: `SlugPage`, `LogoUploadPage`, `CatalogPage`, `DesignStudioPage`, `CheckoutPage` (onboarding), `IdentityModal` | Cubren los 10 pasos del onboarding |
| Escribir suite `onboarding/` (7 specs secuenciales) | Draft→slug→logo→catalog→design→payment→identity→live |
| Escribir `security/sandbox-firewall.spec.ts` | Valida que credenciales live son rechazadas en test environment |
| Implementar `generate-report.ts` | Convierte Playwright JSON → `report.json` normalizado + `report.md` markdown consumible por Fixer Agent |
| GitHub Actions workflow | Corre suite `smoke` en cada PR; suite `full` nightly |
| Configurar project `mobile-chrome` | Mobile viewport para storefront |
| Agregar `data-testid` en apps/web para selectores críticos | PR separado en templatetwo con los attributes necesarios |

**DoD Fase 3:** 25-35 tests, CI operativo, report.json/md generado automáticamente, ejecución < 10 min (smoke) / < 30 min (full).

### D) Backlog de Tareas (priorizado)

| # | Prioridad | Tarea | Fase | Estimación |
|---|---|---|---|---|
| 1 | P0 | Crear repo `novavision-e2e` con estructura base + tsconfig + playwright.config | F1 | 2h |
| 2 | P0 | Implementar `sandbox-guard.ts` (pre-flight check) | F1 | 3h |
| 3 | P0 | Implementar `auth.fixture.ts` (storageState por rol) | F1 | 3h |
| 4 | P0 | Implementar `run-context.ts` + `teardown.ts` | F1 | 4h |
| 5 | P0 | `smoke/health-check.spec.ts` | F1 | 1h |
| 6 | P0 | Configurar traces/video/screenshots on-failure | F1 | 1h |
| 7 | P1 | `storefront/home-render.spec.ts` (render real por slug) | F1 | 3h |
| 8 | P1 | Page Objects `HomePage`, `CartDrawer`, `PaymentResultPage` | F2 | 4h |
| 9 | P1 | `storefront/checkout-debit.spec.ts` (flow real) | F2 | 6h |
| 10 | P1 | `storefront/checkout-credit.spec.ts` | F2 | 4h |
| 11 | P1 | `multitenant/tenant-isolation.spec.ts` | F2 | 4h |
| 12 | P1 | `security/idor-basic.spec.ts` | F2 | 3h |
| 13 | P1 | `security/role-enforcement.spec.ts` | F2 | 2h |
| 14 | P1 | Runner CLI `scripts/run.ts` | F2 | 4h |
| 15 | P2 | Page Objects onboarding (6 pages) | F3 | 6h |
| 16 | P2 | Suite `onboarding/` (7 specs) | F3 | 12h |
| 17 | P2 | `security/sandbox-firewall.spec.ts` | F3 | 3h |
| 18 | P2 | `generate-report.ts` (JSON→MD para Fixer Agent) | F3 | 4h |
| 19 | P2 | GitHub Actions workflow (smoke on PR, full nightly) | F3 | 4h |
| 20 | P3 | Agregar `data-testid` en apps/web (PR en templatetwo) | F3 | 6h |
| 21 | P3 | Project `mobile-chrome` + tests mobile | F3 | 4h |
| 22 | P3 | Firefox project | F1 | 1h |

**Total estimado: ~84h de implementación.**

### E) Preguntas Bloqueantes (máximo 10)

| # | Pregunta | Impacto si no se responde |
|---|---|---|
| 1 | **¿Existe un tenant de test fijo con datos seed y credenciales MP sandbox?** Necesito: `slug`, `client_id`, `mp_access_token` (test), `admin_email`, `user_email`. La referencia en `database-schema-reference.md` menciona `Tienda Test` (`19986d95`) y `urbanprint` (`f2d3f270`), ¿cuál usar? | No se puede escribir ningún test real sin un tenant dedicado |
| 2 | **¿Hay un endpoint `/health` que exponga `mp_sandbox_mode`?** Si no, necesito que el backend lo agregue para implementar el sandbox guard | Sin esto el pre-flight check no puede validar modo test |
| 3 | **¿El storefront acepta tarjetas de test de MP en sandbox?** ¿Se usa el SDK JS de MP o redirect a `init_point`/`sandbox_init_point`? Necesito saber el mecanismo exacto del checkout para automatizarlo | Define si el test de checkout puede ser 100% Playwright o necesita API-only |
| 4 | **¿Qué `data-testid` existen ya en apps/web?** ¿Hay alguna convención? Si no, necesito una PR previa que agregue los selectores críticos | Sin testids estables los selectores serán frágiles |
| 5 | **¿El onboarding flow completo puede correrse E2E en modo sandbox sin DNI real?** El IdentityModal valida regex `/^\d{7,8}$/`, ¿se puede pasar `12345678` en test? | Define si necesitamos bypass para identity en test mode |
| 6 | **¿El provisioning worker corre automáticamente en staging/test, o hay que triggerearlo manualmente?** (`provisioning_jobs` está siempre vacía según la auditoría) | Si no corre, el paso 9→10 del onboarding no se puede testear E2E |
| 7 | **¿Existe un mecanismo para limpiar datos de test en la DB multi-cliente?** ¿Puedo conectarme con service_role_key desde el runner E2E? | Sin cleanup los tests no son repetibles |
| 8 | **¿Las Edge Functions del admin (`admin-create-client`) están disponibles en staging para test?** ¿O ese flujo se testea solo via API directa? | Necesario para tests de onboarding |
| 9 | **¿El `external_reference` se puede extender con un sufijo `:E2E:{runId}` sin romper el routing del `MpRouterService`?** El router parsea por prefijo `NV_ORD:`, necesito confirmar que un sufijo extra no rompe el split | Bloqueante para trazabilidad y cleanup |
| 10 | **¿Cuál es el plan de deploy para staging? ¿Hay un environment estable donde los E2E corran nightly?** Railway staging + Netlify preview, o algo distinto? | Define la infra del CI |

---

**Resumen ejecutivo:** SystemE2E.md es un documento genérico que describe cómo configurar Playwright en abstracto. **No está anclado al producto real.** No menciona multi-tenancy, Mercado Pago sandbox, provisioning, Design Studio, plan gating, `external_reference`, cross-DB sync, ni ninguno de los 10 docs de arquitectura existentes. Los 4 tests existentes en `apps/web/e2e/` son mocks sin contacto con la API real. La propuesta de este informe provee un plan de 3 fases, 22 tareas priorizadas, y una estructura concreta alineada a los flujos reales del sistema. 

Completed: *Entregar informe final* (6/6)

Auditoría entregada. Cuando quieras avanzar con la implementación de cualquier fase, o necesites que responda las preguntas bloqueantes contra el código/DB real, decime y arrancamos.